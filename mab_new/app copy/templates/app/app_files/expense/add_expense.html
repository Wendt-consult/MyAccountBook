{% extends 'app/base/base.html' %}
{% load static %}

{% load common_filters %}
{% load pagination %}

{% block content %}
<style>
.product_heading{
    background-color:#000000;
    padding: 1% 0% 1% 1%;
    margin-bottom: 2%;
    margin-top: 1%;

}
</style>
<div class="row custom-row" style="padding:10px; background: linear-gradient(60deg,#f5700c,#ff9800);">
    <ul style="list-style:none; margin:0px; color:#FFFFFF; padding:0px;">             
        <li class="nav-item" style="float:left;padding:0px 10px;">
            <a href="{% url 'view_expenses' %}" style="color:#FFFFFF; text-decoration:none; font-size: 20px;" title="View Expenses As List">
                <i class="material-icons">list</i>
            </a>
        </li>
        <li class="nav-item" style="float:left;padding:0px 10px;">
            <a href="{% url 'add_expense' %}" style="color:#FFFFFF; text-decoration:none; font-size: 20px;" title="Add Expense">
                <i class="material-icons">add_to_queue</i>
            </a>
        </li>            
    </ul>
</div>

<div class="row">
    <div class="col-lg-12" style="padding:0px">
        <div class="card">
            <input type="hidden" id='edit_expense' value="{{ edit }}">
            <input type="hidden" id='clone_expense' value="{{ clone }}">
            <form method="post" enctype="multipart/form-data" id="expenseForm">
                {% csrf_token %}
                {{ ex_cat_form.management_form }}
                {{ ex_item_form.management_form }}
                <div class="card-header card-header-primary">
                    <h4 class="card-title ">{{ title }}</h4>
                </div>
                <div class="card-body" style="margin-left: 13px;">
                    <div class="row">
                        <div class="col-md-7">
                            <div class="form-group row">
                                <label class="col-md-4" style="margin: 0;">Expense Number</label>
                                <div class="col-md-8" style="padding: 0;">
                                    {{ expense_form.exp_number }}
                                    <div class="auto_generate">
                                        <label style="font-size: 12px;">Auto Generated Expense Number</label>&nbsp;
                                        <input type="checkbox" id='exp_num_check_box'>
                                        <input type="hidden" id='random' value="{{ random_exp_number }}">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-md-4 col-sm-4">Expense Date</label>
                                {{ expense_form.exp_date }}
                                <div id="exp_date_icon">
                                    <i class="fa fa-calendar"></i>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-md-4">Vendor</label>
                                {{ expense_form.vendor }}
                            </div>
                            <div class="form-group row">
                                <label class="col-md-4 col-sm-4">Payment Date</label>
                                {{ expense_form.payment_date }}
                                <div id="payment_date_icon">
                                    <i class="fa fa-calendar"></i>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-md-4">Payment Method</label>
                                {{ expense_form.payment_method }}
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="uploadOuter">
                                <span class="dragBox" >
                                    Darg and Drop File here
                                    {{ expense_form.exp_bill }}
                                    <div id="preview"></div>
                                </span>
                                <input type="hidden" name="remove_file" >
                                <div class="upload_btn_main">
                                    <label for="uploadFile" class="btn_def">Upload</label>
                                    <label class="cancel_file_btn btn_def">Cancel</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br>
                    
                {% if edit and not clone %}
                    <div class="table_form" count='{{ total_cate_form }}'>
                        {% for form in ex_cat_form %}
                        {% with forloop.counter as outer_counter %}
                            {{ form.id }}
                            <input type="hidden" id='cate_tax_{{ forloop.counter }}' value="{{ form.instance.tax }}">
                            <table class="table table-bordered expense_forms table-responsive" id="cate_form_{{ forloop.counter }}" type='cate'>
                                <tr style="background-color: #7b1fa2;">
                                    <th style="color: white; text-align: center;">Category</th>
                                    <th style="color: white; text-align: center;">Amount</th>
                                    <th style="color: white; text-align: center;">Tax</th>
                                    <th style="color: white; text-align: center;">Total Amount</th>
                                    <th style="color: white; text-align: center;">Action</th>
                                </tr>
                                <tr class="ex_cat_form" style="background-color: #0000FF;">
                                    <td><div class="td">{{ form.account }}<br>{{ form.category_description }}</div></td>
                                    <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ form.amount }}</div></td>
                                    <td class="tax_style"><div class="td">{{ form.tax }} <span style="color: white;">%</span></div></td>
                                    <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ form.total_amount }}</div></td>
                                    <td style="text-align: center;">
                                        <div class="td">
                                            <button class="btn btn-sm btn-danger" id='delete_cate_btn_{{ forloop.counter }}' type="button">Delete</button>
                                            {{ form.reference_id }}
                                            <span style="display: none;">{{ form.DELETE }}</span>
                                        </div>
                                    </td>
                                </tr>
                            </table>

                            {% for item_formset in item_formset_list %}
                                {% if item_formset.instance == form.instance %}
                                    {{ item_formset.management_form }}
                                    {% for item_form in item_formset %}
                                        {{ item_form.id }}
                                        <div style="padding-right: 10px; padding-left: 10px;">
                                            <table class="table table-bordered expense_forms item_form_{{ outer_counter }} table-responsive" type='item'>
                                                <tr style="background-color: #7b1fa2;">
                                                    <th style="color: white; text-align: center;">Item</th>
                                                    <th style="color: white; text-align: center;">Quantity</th>
                                                    <th style="color: white; text-align: center;">Rate</th>
                                                    <th style="color: white; text-align: center;">Amount</th>
                                                    <th style="color: white; text-align: center;">Tax</th>
                                                    <th style="color: white; text-align: center;">Total Amount</th>
                                                    <th style="color: white; text-align: center;">Action</th>
                                                </tr>
                                                <tr style="background-color: #006666;">
                                                    <td>
                                                        <div class="td">
                                                            {{ item_form.product }}<br>
                                                            {{ item_form.item_description }}
                                                        </div>
                                                    </td>
                                                    <td><div class="td" style="padding-top: 20px; display: inline-grid;">{{ item_form.quantity }}<span style="color: white; padding-left: 10px;">({{ item_form.instance.product.get_unit_display }})</span></div></td>
                                                    <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i>{{ item_form.rate }}</div></td>
                                                    <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ item_form.amount }}</div></td>
                                                    <td class="tax_style"><div class="td">{{ item_form.tax }} <span style="color: white;">%</span></div></td>
                                                    <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ item_form.total_amount }}</div></td>
                                                    <td style="text-align: center;">
                                                        <div class="td">
                                                            <button class="btn btn-sm btn-danger delete_item_btn" type="button">Delete</button>
                                                            <span>{{ item_form.reference_id }}</span>
                                                            <span style="display: none;">{{ item_form.DELETE }}
                                                            </span>
                                                            <span>{{ item_form.product_unit }}</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                            {% endwith %}
                        {% endfor %}
                    </div>

                {% elif edit and clone %}
                    <div class="table_form" count='{{ total_cate_form }}'>
                        {% for form in ex_cat_form %}
                        {% with forloop.counter as outer_counter %}
                            <input type="hidden" id='cate_tax_{{ forloop.counter }}' value="{{ form.tax.value }}">
                            <table class="table table-bordered expense_forms table-responsive" id="cate_form_{{ forloop.counter }}" type='cate'>
                                <tr style="background-color: #7b1fa2;">
                                    <th style="color: white; text-align: center;">Category</th>
                                    <th style="color: white; text-align: center;">Amount</th>
                                    <th style="color: white; text-align: center;">Tax</th>
                                    <th style="color: white; text-align: center;">Total Amount</th>
                                    <th style="color: white; text-align: center;">Action</th>
                                </tr>
                                <tr class="ex_cat_form" style="background-color: #0000FF;">
                                    <td><div class="td">{{ form.account }}<br>{{ form.category_description }}</div></td>
                                    <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ form.amount }}</div></td>
                                    <td class="tax_style"><div class="td">{{ form.tax }} <span style="color: white;">%</span></div></td>
                                    <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ form.total_amount }}</div></td>
                                    <td style="text-align: center;">
                                        <div class="td">
                                            <button class="btn btn-sm btn-danger" id='delete_cate_btn_{{ forloop.counter }}' type="button">Delete</button>
                                            {{ form.reference_id }}
                                            <span style="display: none;">{{ form.DELETE }}</span>
                                        </div>
                                    </td>
                                </tr>
                            </table>

                            {% for item_formset in item_formset_list %}
                                {{ item_formset.management_form }}
                                {% for item_form in item_formset %}
                                    {% if item_form.reference_id.value == form.reference_id.value %}
                                        <div style="padding-right: 10px; padding-left: 10px;">
                                            <table class="table table-bordered expense_forms item_form_{{ outer_counter }} table-responsive" type='item'>
                                                <tr style="background-color: #7b1fa2;">
                                                    <th style="color: white; text-align: center;">Item</th>
                                                    <th style="color: white; text-align: center;">Quantity</th>
                                                    <th style="color: white; text-align: center;">Rate</th>
                                                    <th style="color: white; text-align: center;">Amount</th>
                                                    <th style="color: white; text-align: center;">Tax</th>
                                                    <th style="color: white; text-align: center;">Total Amount</th>
                                                    <th style="color: white; text-align: center;">Action</th>
                                                </tr>
                                                <tr style="background-color: #006666;">
                                                    <td>
                                                        <div class="td">
                                                            {{ item_form.product }}<br>
                                                            {{ item_form.item_description }}
                                                        </div>
                                                    </td>
                                                    <td><div class="td" style="padding-top: 20px; display: inline-grid;">{{ item_form.quantity }}<span style="color: white; padding-left: 10px;">({{ item_form.product_unit.value }})</span></div></td>
                                                    <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i>{{ item_form.rate }}</div></td>
                                                    <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ item_form.amount }}</div></td>
                                                    <td class="tax_style"><div class="td">{{ item_form.tax }} <span style="color: white;">%</span></div></td>
                                                    <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ item_form.total_amount }}</div></td>
                                                    <td style="text-align: center;">
                                                        <div class="td">
                                                            <button class="btn btn-sm btn-danger delete_item_btn" type="button">Delete</button>
                                                            <span>{{ item_form.reference_id }}</span>
                                                            <span style="display: none;">{{ item_form.DELETE }}</span>
                                                            <span>{{ item_form.product_unit }}</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        {% endwith %}
                        {% endfor %}
                    </div>

                    {% else %}
                        <div class="table_form" count='1'>
                            <table class="table table-bordered expense_forms table-responsive" id="cate_form_1" type='cate'>
                                {% for form in ex_cat_form %}
                                    <tr style="background-color: #7b1fa2;">
                                        <th style="color: white; text-align: center;">Category</th>
                                        <th style="color: white; text-align: center;">Amount</th>
                                        <th style="color: white; text-align: center;">Tax</th>
                                        <th style="color: white; text-align: center;">Total Amount</th>
                                        <th style="color: white; text-align: center;">Action</th>
                                    </tr>
                                    <tr class="ex_cat_form" style="background-color: #0000FF;">
                                        <td><div class="td">{{ form.account }}<br>{{ form.category_description }}</div></td>
                                        <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ form.amount }}</div></td>
                                        <td class="tax_style"><div class="td">{{ form.tax }} <span style="color: white;">%</span></div></td>
                                        <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ form.total_amount }}</div></td>
                                        <td style="text-align: center;"><div class="td">
                                            <button class="btn btn-sm btn-danger" id='delete_cate_btn_0' type="button">Delete</button>
                                            {{ form.reference_id }}</div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                    {% endif %}
                    

                    <div class="row">
                        <div class="col-md-12">
                            <button class="btn btn-sm btn-info dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" >Add Another</button>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                <button type="button" class="dropdown-item" id="add_category_btn" style="padding:5px 5px;">Category</button>
                                <button type="button" class="dropdown-item" id="add_item_btn" style="padding:5px 5px;">Item</button>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 col-xs-12 pd-0">
                            <div class="form-group">
                                <label>Notes</label>
                                <br>
                                {{ expense_form.notes }}
                           </div>
                        </div>
                        <div class="col-md-6" style="padding-top: 30px;">
                            <div class="form-group row sub_i">
                                <label class="col-md-3">Subtotal</label>
                                <i class="fa fa-inr" aria-hidden="true"></i>
                                {{ expense_form.exp_sub_total }}
                            </div>
                            <div class="add_tax">                                
                                <div class="row form-group sub_i" id='tax_5'>
                                    <div class="col-md-3">
                                        <label>Tax</label>
                                        <span style="color: white; padding-left: 5px;">5 %</span>
                                    </div>
                                    <i class="fa fa-inr" aria-hidden="true"></i>
                                    <input type="number" value="0" class="form-control col-md-7" readonly>
                                </div>

                                <div class="row form-group sub_i" id='tax_12'>
                                    <div class="col-md-3">
                                        <label>Tax</label>
                                        <span style="color: white; padding-left: 5px;">12 %</span>
                                    </div>
                                    <i class="fa fa-inr" aria-hidden="true"></i>
                                    <input type="number" value="0" class="form-control col-md-7" readonly>
                                </div>

                                <div class="row form-group sub_i" id='tax_18'>
                                    <div class="col-md-3">
                                        <label>Tax</label>
                                        <span style="color: white; padding-left: 5px;">18 %</span>
                                    </div>
                                    <i class="fa fa-inr" aria-hidden="true"></i>
                                    <input type="number" value="0" class="form-control col-md-7" readonly>
                                </div>

                                <div class="row form-group sub_i" id='tax_28'>
                                    <div class="col-md-3">
                                        <label>Tax</label>
                                        <span style="color: white; padding-left: 5px;">28 %</span>
                                    </div>
                                    <i class="fa fa-inr" aria-hidden="true"></i>
                                    <input type="number" value="0" class="form-control col-md-7" readonly>
                                </div>
                            </div>
                            <div class="form-group row sub_i">
                                <label class="col-md-3">Total</label>
                                <i class="fa fa-inr" aria-hidden="true"></i>
                                {{ expense_form.exp_total }}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12" style="text-align: center;">
                            <div>
                                <input type="hidden" name="button" id="save_button">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" >Save</button>
                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                    <button type="submit" class="dropdown-item save" style="padding:5px 5px;">Save</button>
                                    
                                    <button type="submit" class="dropdown-item save_new" style="padding:5px 5px;">Save & New</button>
                                    
                                    <button type="submit" class="dropdown-item save_print" style="padding:5px 5px;">Save & Print</button>
                                </div>
                                &nbsp;&nbsp;&nbsp;
                                <a class="btn btn-warning" href="{%url 'view_expenses' %}">Cancel</a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Extra Category Form -->
<div class="extra_cate_form" style="display: none;">
    <table class="table table-bordered expense_forms table-responsive" type='cate'>
        <tr style="background-color: #7b1fa2;">
            <th style="color: white; text-align: center;">Category</th>
            <th style="color: white; text-align: center;">Amount</th>
            <th style="color: white; text-align: center;">Tax</th>
            <th style="color: white; text-align: center;">Total Amount</th>
            <th style="color: white; text-align: center;">Action</th>
        </tr>
        <tr style="background-color: #0000FF;">
            <td><div class="td">{{ ex_cat_form.empty_form.account }}<br>{{ ex_cat_form.empty_form.category_description }}</div></td>
            <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ ex_cat_form.empty_form.amount }}</div></td>
            <td class="tax_style"><div class="td">{{ ex_cat_form.empty_form.tax }} <span style="color: white;">%</span></div></td>
            <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ ex_cat_form.empty_form.total_amount }}</div></td>
            <td style="text-align: center;">
                <div class="td">
                    <button class="btn btn-sm btn-danger delete_cate_btn" type="button">Delete</button>
                    <span>{{ ex_cat_form.empty_form.reference_id }}</span>
                </div>
            </td>
        </tr>
    </table>
</div>

<!-- Extra Item Form -->
<div class="extra_item_form" style="display: none;">
    <div style="padding-right: 10px; padding-left: 10px;">
        <table class="table table-bordered expense_forms table-responsive" type='item' style="width: 100%;">
            <tr style="background-color: #7b1fa2;" class="item_header">
                <th style="color: white; text-align: center;">Item</th>
                <th style="color: white; text-align: center;">Qunatity</th>
                <th style="color: white; text-align: center;">Rate</th>
                <th style="color: white; text-align: center;">Amount</th>
                <th style="color: white; text-align: center;">Tax</th>
                <th style="color: white; text-align: center;">Total Amount</th>
                <th style="color: white; text-align: center;">Action</th>
            </tr>
            <tr style="background-color: #006666;">
                <td><div class="td">{{ ex_item_form.empty_form.product }}<br>{{ ex_item_form.empty_form.item_description }}</div></td>
                <td><div class="td">{{ ex_item_form.empty_form.quantity }}<span style="color: white; padding-left: 10px;"></span></div></td>
                <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ ex_item_form.empty_form.rate }}</div></td>
                <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ ex_item_form.empty_form.amount }}</div></td>
                <td class="tax_style"><div class="td">{{ ex_item_form.empty_form.tax }} <span style="color: white;">%</span></div></td>
                <td><div class="td"><i class="fa fa-inr" aria-hidden="true"></i> {{ ex_item_form.empty_form.total_amount }}</div></td>
                <td style="text-align: center;"><div class="td">
                    <button class="btn btn-sm btn-danger delete_item_btn" type="button">Delete</button>
                    <span>{{ ex_item_form.empty_form.reference_id }}</span>
                    <span>{{ ex_item_form.empty_form.product_unit }}</span>
                </div>
                </td>
            </tr>
        </table>
    </div>
</div>

<!-- Add Payment Method Popup -->
<div class="modal fade" id="paymentMethodModal">
    <div class="modal-dialog payment_dialog">
        <div class="modal-content" style="background-color: #1a2035">
            <div class="modal-header payment_modal_header">
                <h4 class="modal-title">Add New Payment Method</h4>
                <button type="button" class="close_btn" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" style="padding-top: 30px;">
                <div class="row">
                    <div class="col-md-5">
                        <label>Payment Method Name*</label>
                    </div>
                            
                    <div class="col-md-7">
                        <input type="text" name="payment_method" class="form-control" style="width: 100%;">
                    </div>
                </div>
                <span class="text-danger" id='pm_error'>Method Already Exists</span>   
            </div>  
            <div class="modal-footer payment_modal_footer">
                <button type="button" class="btn btn-sm btn-success add_payment_method_btn">Add</button>
                <button type="button" class="btn btn-sm btn-warning close_btn" data-dismiss="modal">cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Popup -->
<div class="modal fade" id="productFormModal">
    <div class="modal-dialog product_modal_dialog">
        <div class="modal-content" style="background-color: #1a2035;">
            <div class="modal-body">
                <div class="subs_div prod_form_width">
                    {% include 'app/app_files/products/add_products_form_extended.html' %}
                </div>   
            </div>     
        </div>
    </div>
</div>

<!-- Add Contact Popup -->
<div class="modal fade" id="contactFormModal">
    <div class="modal-dialog contact_modal_dialog">
        <div class="modal-content" style="background-color: #1a2035;">
            <div class="modal-body">
                <div class="subs_div">
                    {% include 'app/app_files/contacts/add_contacts_extended.html' %}
                </div>   
            </div>     
        </div>
    </div>
</div>

<!-- Add Ledger Popup -->
<div class="modal fade" id="ledgerFormModal">
    <div class="modal-dialog ledger_modal_dialog">
        <div class="modal-content" style="background-color: #1a2035;">
            <div class="modal-body">
                <div class="subs_div">
                    {% include 'app/app_files/acc_ledger/add_accounts_ledger_extended.html' %}
                </div>   
            </div>     
        </div>
    </div>
</div>

<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript">
    var file = "{{ file }}";
</script>
{% endblock %}



