{% extends 'app/base/base.html' %}
{% load static %}

{% load common_filters %}
{% load pagination %}

{% block content %}
<style>
/* loader */
.loader {
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid #3498db;
  width: 120px;
  height: 120px;
  -webkit-animation: spin 2s linear infinite; /* Safari */
  animation: spin 2s linear infinite;
  margin-left: 42%;
}

/* Safari */
@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.icons{
    cursor: default;
}
.icons:hover{
color: white!important;
}

/* draggable targets */
[data-draggable="target"]
{
    float:left;
    list-style-type:none;
    
    width:48%;
    height:14.5em;
    overflow-y:auto;
    
    margin:0 0.5em 0.5em 0;
    padding:0.5em;
    
    border:2px solid #888;
    border-radius:0.2em;
    
    background: #202940;
    color: white;
}

/* draggable items */
[data-draggable="item"]
{
    display:block;
    list-style-type:none;
    
    margin:0 0 2px 0;
    padding:0.2em 0.4em;
    
    border-radius:0.2em;
    
    line-height:1.3;
}
</style>
<div class="row custom-row" style="padding:10px; background: linear-gradient(60deg,#f5700c,#ff9800);">
    <ul style="list-style:none; margin:0px; color:#FFFFFF; padding:0px;">             
        <li class="nav-item" style="float:left;padding:0px 10px;">
            <a href="{% url 'view_expenses' %}" style="color:#FFFFFF; text-decoration:none; font-size: 20px;" title="View Expenses As List">
                <i class="material-icons">list</i>
            </a>
        </li>
        <li class="nav-item" style="float:left;padding:0px 10px;">
            <a href="{% url 'add_expense' %}" style="color:#FFFFFF; text-decoration:none; font-size: 20px;" title="Add Expense">
                <i class="material-icons">add_to_queue</i>
            </a>
        </li>            
    </ul>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header card-header-primary">
                <div class="row" >
                    <div class="col">
                        <h4>View Expense</h4>
                    </div> 
                    <div class="col-1">
                        <span class="material-icons icons" data-toggle="modal" data-target="#CustomizeViewModel" style="margin-top: 4%;color: rgba(190, 186, 186, 0.781);">settings</span>                           
                    </div>                               
                </div>
            </div>
            <div class="card-body">
                <div class="loader" style="display: none;"></div>
                <div class="table" id="customize_table">
                    <input type="hidden" id="print_expense" value="{{ expense_id }}">
                    <a href="" target="_blank" id="link"><span style="display: none;">click</span></a>
                    <table class="table-bordered" width="100%" cellspacing="0">
                        <thead  style="background-color: #EEEEEE; color:#000000; font-size:11px">
                            {% if customize.expense_vocher != 0 %}
                            <th class="text-center customize_vocher">Expense Voucher</th>
                            {% endif %}
                            {% if customize.expense_date != 0 %}
                            <th class="text-center customize_date">Expense Date</th>
                            {% endif %}
                            {% if customize.expense_vendor != 0 %}
                            <th class="text-center customize_vendor">Vendor</th> 
                            {% endif %}
                            {% if customize.expense_payment != 0 %}
                            <th class="text-center customize_payment">Payment Date</th>
                            {% endif %}
                            {% if customize.expense_method != 0 %}
                            <th class="text-center customize_method">Payment Method</th>
                            {% endif %}
                            {% if customize.expense_amount != 0 %}
                            <th class="text-center customize_amount">Total Amount</th>
                            {% endif %}
                            <th class="text-center">Action</th>                
                        </thead>
                        <tbody>
                            {% for expense in all_expense %}
                                <tr>
                                    {% if customize.expense_vocher != 0 %}
                                    <td class="text-center customize_vocher">{{ expense.exp_number }}</td>
                                    {% endif %}
                                    {% if customize.expense_date != 0 %}
                                    <td class="text-center customize_date">{{ expense.exp_date|date:"d/m/Y" }}</td>
                                    {% endif %}
                                    {% if customize.expense_vendor != 0 %}
                                    <td class="text-center customize_vendor">{{ expense.vendor }}</td>
                                    {% endif %}
                                    {% if customize.expense_payment != 0 %}
                                    <td class="text-center customize_payment">{% if expense.payment_date %} {{ expense.payment_date|date:"d/m/Y" }} {% else %} - {% endif %}</td>
                                    {% endif %}
                                    {% if customize.expense_method != 0 %}
                                    <td class="text-center customize_method">{% if expense.payment_method %} {{ expense.payment_method }} {% else %} - {% endif %}</td>
                                    {% endif %}
                                    {% if customize.expense_amount != 0 %}
                                    <td class="text-center customize_amount">{{ expense.exp_total }}</td>
                                    {% endif %}
                                    <td class="text-center">
                                        <button class="btn btn-primary dropdown-toggle btn-sm" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" >Action</button>
                                        
                                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                            <a class="dropdown-item" title="Edit Expense" href="{% url 'edit_expense' expense.id %}" class="btn btn-primary btn-sm" style="padding:5px 5px;">
                                                Edit
                                            </a>
                                            <button class="dropdown-item delete_expense" title="Delete Expense" type="button" id="{{ expense.id }}" class="btn btn-primary btn-sm" style="padding:5px 5px;">
                                                Delete
                                            </button>
                                            <a class="dropdown-item" title="Print Expense" href="{% url 'generate_pdf' expense.id %}" class="btn btn-primary btn-sm" target="_blank" style="padding:5px 5px;">
                                                Print
                                            </a>
                                            <a class="dropdown-item" title="Clone Expense" href="{% url 'clone_expense' expense.id 'clone' %}" class="btn btn-primary btn-sm" style="padding:5px 5px;">
                                                Make a Copy
                                            </a>
                                        </div> 
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- customize view -->
<div class="modal fade" id="CustomizeViewModel" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="background-color:#202940">
            <form method="post" style="margin:0px" action="{% url 'edit_tax_details_form' %}">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" style="color:#000000; font-weight:bold;">Customize List</h5>
                    <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button> -->
                </div>
                <div class="modal-body">
                    {% csrf_token %}
                    <h5 style="color: white;text-align: center;margin-bottom: 1%;">Drag and drop be column name you want to show or hide</h5>
                    <ol data-draggable="target" id="first">
                        <h4 style="text-decoration: underline;">Show Column</h4>
                        {% if customize.expense_vocher != 0 %}
                        <li data-draggable="item" id="customize_expense_vocher">Expense Vocher</li>
                        {% endif %}
                        {% if customize.expense_date != 0 %}
                        <li data-draggable="item" id="customize_expense_date">Expense Date</li>
                        {% endif %}
                        {% if customize.expense_vendor != 0 %}
                        <li data-draggable="item" id="customize_expense_vendor">Vendor</li>
                        {% endif %}
                        {% if customize.expense_payment != 0 %}
                        <li data-draggable="item" id="customize_expense_payment">Payment Date</li>
                        {% endif %}
                        {% if customize.expense_method != 0 %}
                        <li data-draggable="item" id="customize_expense_method">Payment Method</li>
                        {% endif %}
                        {% if customize.expense_amount != 0 %}
                        <li data-draggable="item" id="customize_expense_amount">Total Amount</li>
                        {% endif %}
                      </ol>
                      
                      <ol data-draggable="target" id="seconde">
                          <h4 style="text-decoration: underline;">Hide Column</h4>
                          {% if customize.expense_vocher == 0 %}
                          <li data-draggable="item" id="customize_expense_vocher">Expense Vocher</li>
                          {% endif %}
                          {% if customize.expense_date == 0 %}
                          <li data-draggable="item" id="customize_expense_date">Expense Date</li>
                          {% endif %}
                          {% if customize.expense_vendor == 0 %}
                          <li data-draggable="item" id="customize_expense_vendor">Vendor</li>
                          {% endif %}
                          {% if customize.expense_payment == 0 %}
                          <li data-draggable="item" id="customize_expense_payment">Payment Date</li>
                          {% endif %}
                          {% if customize.expense_method == 0 %}
                          <li data-draggable="item" id="customize_expense_method">Payment Method</li>
                          {% endif %}
                          {% if customize.expense_amount == 0 %}
                          <li data-draggable="item" id="customize_expense_amount">Total Amount</li>
                          {% endif %}
                      </ol>
                      
                      
                </div>
                <div class="modal-footer">
                    <button class="btn btn-sm btn-success" type="button" onclick="customize_view(6)">apply</button>
                    <a class="btn btn-sm btn-danger" href="{% url 'view_expenses'  %}" type="reset">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
/*******************************************************************/
// CUSTOMIZE VIEW LIST
/*******************************************************************/
// $(document).ready(function(){
    csrf_token = '{{csrf_token}}';

/*******************************************************************/
// CUSTOMIZE VIEW LIST
/*******************************************************************/
// $(document).ready(function(){
 
    function customize_view(ids){
    $('#CustomizeViewModel').modal('hide')
    data = {}
    if(ids == 6){
        if($('#first #customize_expense_vocher').length){
            data['vocher'] = 1
        }else{
            data['vocher'] = 0
        }

        if($('#first #customize_expense_date').length){
            data['date'] = 1
        }else{
            data['date'] = 0
        }

        if($('#first #customize_expense_vendor').length){
            data['vendor'] = 1
        }else{
            data['vendor'] = 0
        }

        if($('#first #customize_expense_payment').length){
            data['payment'] = 1
        }else{
            data['payment'] = 0
        }

        if($('#first #customize_expense_method').length){
            data['method'] = 1
        }else{
            data['method'] = 0
        }

        if($('#first #customize_expense_amount').length){
            data['amount'] = 1
        }else{
            data['amount'] = 0
        }

    }
     $.ajax({
      url: '/customize_view/'+ids+'/',
      type: 'POST',
      data: {'data':JSON.stringify(data), 'csrfmiddlewaretoken':csrf_token},
      beforeSend: function(){
       // Show image container
       $('#customize_table').hide();
       $(".loader").show();
       
      },
      success: function(data){
        if(ids == 6){

            if(data['vocher'] == 1){
                $('.customize_vocher').show()
            }else{
                $('.customize_vocher').hide()
            }

            if(data['date'] == 1){
                $('.customize_date').show()
            }else{
                $('.customize_date').hide()
            }

            if(data['vendor'] == 1){
                $('.customize_vendor').show()
            }else{
                $('.customize_vendor').hide()
            }

            if(data['payment'] == 1){
                $('.customize_payment').show()
            }else{
                $('.customize_payment').hide()
            }
    
            if(data['method'] == 1){
                $('.customize_method').show()
            }else{
                $('.customize_method').hide()
            }
    
            if(data['amount'] == 1){
                $('.customize_amount').show()
            }else{
                $('.customize_amount').hide()
            }
        }
      },
      complete:function(data){
       // Hide image container
    //    $("#loader").hide();
        $(".loader").hide();
        $('#customize_table').show();
        
      }
     });
    
    };
//    });

// *************************************************//

(function()
{

    //exclude older browsers by the features we need them to support
    //and legacy opera explicitly so we don't waste time on a dead browser
    if
    (
        !document.querySelectorAll 
        || 
        !('draggable' in document.createElement('span')) 
        || 
        window.opera
    ) 
    { return; }
    
    //get the collection of draggable items and add their draggable attribute
    for(var 
        items = document.querySelectorAll('[data-draggable="item"]'), 
        len = items.length, 
        i = 0; i < len; i ++)
    {
        items[i].setAttribute('draggable', 'true');
    }

    //variable for storing the dragging item reference 
    //this will avoid the need to define any transfer data 
    //which means that the elements don't need to have IDs 
    var item = null;

    //dragstart event to initiate mouse dragging
    document.addEventListener('dragstart', function(e)
    {
        //set the item reference to this element
        item = e.target;
        
        //we don't need the transfer data, but we have to define something
        //otherwise the drop action won't work at all in firefox
        //most browsers support the proper mime-type syntax, eg. "text/plain"
        //but we have to use this incorrect syntax for the benefit of IE10+
        e.dataTransfer.setData('text', '');
    
    }, false);

    //dragover event to allow the drag by preventing its default
    //ie. the default action of an element is not to allow dragging 
    document.addEventListener('dragover', function(e)
    {
        var ids = $(item).parent().attr("id");
        var count = $('#'+ids+' li').length;
        if(ids == 'first'){
                if(count > 1){
                    if(item)
                    {
                        e.preventDefault();
                    }
            }
        }else if(ids == 'seconde'){
            
            if(item)
                {                    
                    e.preventDefault();
                }
        }
        
        
    
    }, false);  

    //drop event to allow the element to be dropped into valid targets
    document.addEventListener('drop', function(e)
    {
        //if this element is a drop target, move the item here 
        //then prevent default to allow the action (same as dragover)
        if(e.target.getAttribute('data-draggable') == 'target')
        {
            e.target.appendChild(item);
            
            e.preventDefault();
        }
    
    }, false);
    
    //dragend event to clean-up after drop or abort
    //which fires whether or not the drop target was valid
    document.addEventListener('dragend', function(e)
    {
        item = null;
    
    }, false);

})();   
</script>
{% endblock %}

{% block js %}

    <script type="text/javascript">
        $('.delete_expense').on('click', function(){
            if(confirm('You want to delete this expense?')){
                var expense_id = $(this).attr('id');
                url = "{% url 'delete_expense' 0 %}"
                window.location.href = url.replace('0',expense_id);
            }
        });

        if ($("#print_expense").val()){
            str = "{%url 'generate_pdf' 0 %}"
            url = str.replace("0", $("#print_expense").val());
            $('#link').attr('href', url);
            $('#link').find("span").trigger("click");
        }

    </script>
{% endblock %}
